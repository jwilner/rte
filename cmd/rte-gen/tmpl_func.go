package main

import (
	"bytes"
	"fmt"
	"io"
	"text/template"
)

var (
	tmplFunc = template.Must(template.New("").Parse(`
// Code generated by cmd/rte-gen/gen.go DO NOT EDIT.
package rte

import (
	"net/http"
)

// generated handler wrappers which avoid allocs

{{ range $sig := .Signatures }}
{{ if and (not .Arr) (gt .Count 0) }}
// {{ .Name }} takes in a standard http handler also expecting {{ .Count }} path variable values and returns a valid bound handler
func {{ .Name }}(f func(w http.ResponseWriter, r *http.Request, {{ range $idx, $p := .PNames }}{{ if $idx }}, {{ end }}{{ $p }}{{ end }} string)) Handler {
	return func(w http.ResponseWriter, r *http.Request, pVars pathVars) {
		f(w, r, {{ range $idx, $el := .PNames }}{{ if $idx }}, {{ end }}pVars[{{ $idx }}]{{ end }})
    }
}
{{ else if eq .Count 0 }}
// {{ .Name }} takes in a no path variable handler and returns a Handler fit for static paths
func {{ .Name }}(f func(w http.ResponseWriter, r *http.Request)) Handler {
	return func(w http.ResponseWriter, r *http.Request, _ pathVars) {
		f(w, r)
	}
}
{{ else if eq .Count $.MaxVars }}
// {{ .Name }} takes in handler expecting array of {{ $.MaxVars }} path variable values and returns a valid handler
func {{ .Name }}(f func(w http.ResponseWriter, r *http.Request, pVars [maxVars]string)) Handler {
	return func(w http.ResponseWriter, r *http.Request, pVars pathVars) {
		f(w, r, [maxVars]string(pVars))
	}
}
{{ else }}
// {{ .Name }} takes in handler expecting array of {{ .Count }} path variable values and returns a valid handler
func {{ .Name }}(f func(w http.ResponseWriter, r *http.Request, pVars [{{ .Count }}]string)) Handler {
	return func(w http.ResponseWriter, r *http.Request, pVars pathVars) {
		var trimmed [{{ .Count }}]string
		copy(trimmed[:], pVars[:])
		f(w, r, trimmed)
	}
}
{{ end }}
{{ end }}
`))
)

func writeFunctionFile(w io.Writer, sigs []Signature) error {
	var buf bytes.Buffer
	if err := tmplFunc.Execute(&buf, struct {
		Signatures []Signature
		MaxVars    int
	}{sigs, 8}); err != nil {
		return fmt.Errorf("tmplFunc.Execute: %v", err)
	}

	return writeFormatted(buf.Bytes(), w)
}
